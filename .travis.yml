services:
- docker
env:
  matrix:
  - COMPOSE_VERSION=3.9
  global:
  - DATABASE_NAME=todo_app_db
  - APP_NAME=todo-app-corndel
  - TF_VERSION=1.0.11
  - secure: S4xtHUvLkLZCR+JmPUarsa2R+DfEI6xKdNr/YQ4mdjA+vdbJibl2N3QsCFmh6iEyKiRxILLUOQN6OAn3zP9wOk0OAr5HlRX2ell4MgGMcn3NjqPBLaYR6Z4GfTX0XOj3O7yjrmlifeDTm/kZxoRNAOfb5ttRomPYMTHHuBXM2tMMzsdSNcrFWs4aPALmfSsvDHOA7N7R8xLXLJZz4PEY/3Tzdvq22ZJvdCWhIJrjgcbPbZuSfsXiL82ocwpu/Gz0TABUC0Hsh/DtqCt8jMJbuHVqcEOjstxpM7N58a7CaCFVcA3ZsOOe+2K7i23kC+6RHyY7haIwh+xcyWnDLMlC8T2zNnlKwzedFz/CSVzngn1URp+t+08bT4RVBBgBdCcnka0TemHeJkgCACCgaGEDlorPEoAoU+ddJS5+spapeW2OisYovUUFv6btYwbP+z+tHp2gaLJbdn4qE70MODpfl5/aHmWaCk7MYG30Bq8PhB65BqW2kN7kuLRz3rUQf3AhTBmVF/DjtlXATeiWEe9ZiYwKVua/Vk9QxVRkt3MW4Rjq4OIJbz5UGGxNZylcCAYBhdv1Cd2J8wDRjvGL7zZoLKhdhExKCFgsQuu4e2f8eJMbflmDnYfckGKZqFPiIxUkMPYzQ+bP1Y5UFi+kc5asuzRXzeqejXmsxGNCM9EFH/I=
  - secure: Q1Ynbx0f5biAomX2OrgZ3cicDGnOPLZ66Z3dGmtDb7+YGy7Y6/q2JJQlAQanNS/+jSB0pHoB7Yk/9/00hXStCFV9Oi4tCUgFmkgKu7IU8cJs8g77v3SOqQpMFKIlN7I7Mv1hd3AnCBKZ2bRd9bwC+8EanUcT9ulN7gz/5TWMBqFvBS8pKeXaws9SDBg/VVys+qxvnhOaoaT7xmhSMAhTJrv39oznbDL+0tAUfN5JGoyUbvGl+0SUAD5jGGCnZuPTlOl497/mJAGBflEQSWXEQAeFnCdfgQeTiO40o/kA7L4Vo+ertP+jhzjjNKLSdKRNfyoWzl8DoM7HqpEQcPK+O+w6eMk5oMLWTIa2B3xc87uNZtJg/Ub10N2eq/AG4qv89wj6ApaWXG3WmbAUohmpwhfL/ekJ4f8cM2vuWMSxxZVW+6vixObK2dv3vzQOZbO/BCO4n2QmRdCvyg/eQQoE+ACJTqHczhVW1T2le/MoZfT1RT3SuxTtAwS9jWvql7Cf0iphmWrUuuKzaUBBG5D0Q998umg8Vj8mqfmUGnwwDO0V0Usadj2qJsJleQO/atoRsOZbhxTIPgXLpNz2yWiGxst81nxboMSaHgVrX7VeraA/RXtbLJU18ALFbZptK/ars4UM8x2xWuRtHYUa41hpa6F1iqVA6FCjNXaw4jVe3QM=
  - secure: jpowSVCTVhJGHliDJM7zpyNuxOVL0T3w/thMX4MZ4Xw3lMIn22nDvSIRVBK2sVrjH6UePkA84k7uGL+rbzn9S/6hJvbAb2BuuWi2m2cHA4fwxe8nzCHIz3nhWqM10KRemB2maRCBNJvFDz8NxYWhXjiz/Q++/B1p2zrkTbBFLs9ue+Nphq5n3szLCJLGw23jnwaiwq9hP382tc1FX8/5cecbOehpCYJLMTmN7XwdDBCkqwGiUYcs3ZvHXn3bOPoX+9ynDBHcrNYyYgnJdZkGrzPWbpBTR//PLYpB47ZRbXCfLTcxYuKLsSHWCSR6T0uco69JymEqMkAUVE9+jEzSc1g/u6GBLH77B7oonrOL69g1E4C27uXkPNE5+QM/a5mNKI2RM5/Ok7LcHm0SVdgqzehcLRYBr6rMtN86IYrvD85+m72Au2cPrQ/+5q2DlpQXs/AOkn032oHcgTl9YRQnVzdwcPficKZNHnlQpMyeOXg9gQjOzw/ijh6XqjxFnohpON2X1Xyib/9Cw2lsdYrEZqDnAEzu9bkazt3fuidrk66/sAsJ0gAhaQ765Al7HOIX8kbLsRhTaNREEnXfGwJMwTot3hCIhK64kPYleOTevYLMfmoEekkRWrpRzhhN/tTlNHXNhqqz3bqbM6UHVrWr9kojoHchrgg7aTQjp/cH/aY=
  - secure: qfyZGBMTFfjm6MEgFZ6D9m6V+/eqiy9LcwvxsP+qXcAJtxUzguW2552vrGVsSGzM4juUXUpL7GiuIBKU2vsFxoEJW6V5PQtAh4zMQESfGisjsJ190To0cPmh8EXhPmIRkGkHN4RSFfZNbBq/mRweeytZSGf09nBcKW+KZhpBDohR3QkqX0kZnfuOAHpHrtZlHRLABWR1xr1L7WWbykEQkbsp2bG2StsCzNKQjkhDL7fYLyyc6q2CTtCZjR7coDrQG89XjOr76USgufnOzZ5rLZIM4UDRYcX1+d/binDjauGmYJuVJ7435VJq3eHJ7A+2soqz52OF/JQYX5WAM/bs9KbMQw0ZVjffcC5SEzrgWA0Qsld0SA9H4LPDZgKJtASSWO52GZ9WDBSukvQjcUNIDXJ8ez+wGVr4C6vUbjOo14snOA4+MDQoZVkcaHLNkAeae8WBvrGNcS9sd8Ijxr8EtpwkOUdZ21DBbYY5knKWUpHy+79XWJheWYdw9Hu/xAQUGTsX+xzZfYlsJkbM0CUafdvuyHLgyubPk3BQh+bnZ0fZwn5wbjnLuG6d54v6tvSipdUbSToXGvl70aVliub61i3sK8XmfmtGvPj2bMzgRLUaTSit1CKaTpi0/YRR7DicHX0kT4fMTXx1mWKugymmQTiQfXgdYwkSxUdIWKJWnDQ=
  - secure: gfhhwXgKZTNJIZF8IrD2RkIzj9fpl2B+uJGh9pSzsQJVaVRPZWgC+bwNgk3CXdshf1TtKpiqL1d94UnPrCC/jDDDvVW8qQLRnAI8RYiSOfupZ1NwqTBLwm8fqeKpJ1dvd35v9fNCwsVmj5208hO+O1AxbwkZDkks/QaRYDJuN27Iy9S+5oswLVnhihwOY3uO8Kr+taZa8P8T4YxnyzTeLxJLalpiJY0aHvNgiEpIlR6RZ0zp52syQFUdZ485EyuP/4oghdzdAuNG02jHDmlTajYQhNOo8vYJJm3CuX/9sJS5qKUfcrZ8x+Cdgo6SqfcM10rQQzd6rb+vZutOKg0cFcdHX/Dt4VI4np4/xmcsqolYTOGF60FOUrgY3RVkg1SKEyGneuwU9hjcWyWhO5ypnK6xmcCX2/yT+I7AK4ze3tnTfTnmIo6pV8o7afk66fztEQqRom1w7wg9WmamDYUqTJOvV+0/CTTHPRHUVKHAG2Lya9eCEAXgPN8WWcu58czsf0W+19gIPiegGiZjoo9al3xkC1Qa3B/0az+yC7EuVmW3EIO5f6ahd3NSGsYYCAQ0BekyB0xPmM+9rn5UPfXxA1d+hSh9yftgwVwWGN5QPpd90IMf53XwkSSVp/aLI5gOzE4FgJwQ6gASv2yb0S+iany8veocIAFfl6VaAWAJgaU=
  - secure: JSZQ4nX0O1UWfHZJVDCAjdxBahjPZwz6Bpo9oRGqaDnqcStFIByjEoXjKbmQXut79+lPUoWIGTEcHEe+xs9z53wP0GkEsVOvHFjvK2bQ4qd2TDO19OfOscYggvQ+z1Fbn+QTeqbSNthTPf0N3Ee1U4sQjZloZaWxcW+U3O9DYdB/fPqMosuglcfQzXKCINK3Ln8BH71G+j9XLGs9c+eU82UoQ84uRKByaJah9QFfU/DO1PHg5M4e4HSGAHDXIyuNZkOMleEf5/P4o3FJiaws6yzN9rS0Gjq25xzaVqMt1GCneqaPpoOCd0QhCwpdc79jcW4a6H3w1vXB8+ACdLUvi96T5h9rmUoRB1Xkc9nFGqCcMA9JYSb5YdKWO6nhTCCZ0hGKQsBlkwzSbnfh/IqI4W41NNu6OguMmkkjhV3rrJO8Prnthd5APv6BdHZkgn0IEIYGOizoSHPywhKgkhTdMIc7gTjSMVkkr+ePNV0R+ZlYBY0uvPKgXx+ehVrNySe1NAMhadY6zbgy1CxIwrDqynbml5tsI2sBXNFUNwqS08qjx28MovUXNqA/lvpoGsTsUmKarN/v7Lo0Axt/5uea3MEIrls2ZhjgfO1OMD0DHMCLOHxokFoEabCfbg3jFLhCZj9DWcQ+D87L+lEHW1fQmsBp1SRXIgG5bO2mgR5Mq2U=
  - secure: db5BKoxKqy/KSEe60tqVtUEqYZ69wJFZv31diXOsgaUW4CpXRJAmLK1KQXNQGsG9nQ6WmgQSU/6Z0Y7rXKc0mkyjkahBHJJFzy901iPVP/hu11rFdJcrGtuzOl9+P2Gx7fy8pi9kZUQOfr3GQTAe3kkJpnXHHRrfEO46lWJkalm3d1k8FQGtllr6LgCC1UTzglGuLUNvPcCjiQM03kWDP6Urxq70pyCM1QTR2jDg7DWgy4J8+E+lLC1HtBLXXi6VllOIr4+U6zYe43ZN1s41cMvUpm7w/kEOKo6ZAmKQOiMxX5kUBEPZVEvVwGvhtu0cXE9adyitM/nsXVhLGM8Pst3C4RynRau/yFo+SOGPsxpWrrQwpt3HiJy5yLFqQz2T5YfPjTEG2awkG2+N74psnm94n0+HD/tppbYhhW5b5nwBiAcjF22bkdHT+fWyoQy5bgPUJbnayL6NzaccI5Rje9Gx+ChlASZepeIRz1PnLsK2qyH00d+CxrT3U/Yyci9WGHwYxnFstYj8uGJFR0z8ixiKp/wAP2vIW3F9jfIubRwa2niR1E0amBWKATOaNUyWqjTcucvW8HlV5hPJqIVOr+5enmMLUnkaoK1XHX1A+uBtyfl0C2xTxa9onVqYesbUNq4RYGNGxIxfKDRZQWqOYl9jAm5xp4Q9O3T9Z9jg4a4=
  - secure: cWQoAGfpxgSsZywHSP1FaZZ5kciD7L+jSeJCwpV4VoyJKi31wopKbhcn8Ony33eole+oho4v137pS37IIOP8RNMz6RWbP4ZqpmY2nNQ0HIMKo9kuPaIZ0PR40sHnd2LIgSOCY5dT4k9rPquiQQuYiZPP0RuspJdVKzns7KX7icHPvwmb/aar8KfdoiQKtZ9O9bKmGl/fPSwHXSvC9rAXPtvIQYizfmqtoELKIGD7/hraZ2WakTSiTXkanLYBC3PXkSZxYweQnp3O3AtaEM735TnHoRgFqT/dHi3lz0AtsQmI5R6AsjHUpeaVvYyCpjx0Adu0X392qQEpOZW0WK8uRz/cjpH1AaqArbQtu/k1cZ6K6plOh0b0MrMGrL+AeNGnE8JSVdg66Ci+OqJvbOvKz52fswwKSxqDEhWnq+au1jvCXWG+HoFI4dV/l93/eQXpQBH1ZnmKvqB0J5+Ty4ha0cxzGAm4plEr1IK770I+eVJJRgj6y62/f1M63vVyTV+l3z3pVRwMA5CfKxIsr1bQPeums+FQce6qdm/f7Vwt6BYpeUgu+v/t6f6tul2xiwLMf+R0hWu0+nYdrbsJhGoxZQt2GkR8/xy3oUnOuekzA+2daFymHnvqiRQ9AFacmrlbw8VPeaL5t8VnjcV56reXEGF93e9baGMcfEw5LodmZgA=
  - secure: 0nTpTFa5496Nss5xwjmSgmiCmfm2O4sfvNX1D0FD5tzL4KZR3xTkKA9PrkBvpQ5MI7NyG15zpSCUC9f7z45Rwhm7qRuAj+32FLlc4OpHLpJ0pbkmsQmWwn9wAJYynBj7zSAEsDaH+pLOqcwgHaaA1Jeh1qHPBKXiNHhXXXs1bvw4mbFgDLlb+ZhtK9aChAuk/VFZMbNbde/ztUrn40OeurhL7erJFI5Qaj96DuFeJBLQtZlf2dNbkUgrfx+AbUZ2uK4qAbUzceSpmcW7GMnVMVT/74FByQs9mNP3XJypnYsshy6WfxnE6RinW1aeAbn7GQTZeIftuWIgzphPTpJcPUYEGeTaUfOVbyqigYtY/9D11JwS0fpUcORUjq4XdW/ZXHiF47hy7FJ0Qn6gGE3SHgevEZ7Q2tLXLevWfYQJe1rXCsDAL9xeIbfyduZ0XHWbVBEU0D1Cv0+Kb/AlIx31CJzAMFJOWPv4Tt54novxEg5h6i7EWdiY/GYs+G23LuOIYMXe/moMWf6hgFnc8d+2mO/GYnHxfKLi2uBX+xR/NLnQdwp1vjuoyNkNryX3XLBIPMxDLf4vqqiQZK3VRNY/i9ddt8/vmu5h+deH8TMlOph5AZd5QgHmdEGu5CcptWmbOBleOc7l8adfjKXOr/2qgqojpJaqCFr5nRPcDy0RtFs=
  - secure: Prs0gmID9nigvSamlZnr1ocdG2l2ZCgCK48t+EnOpBoluKum8BBn9HNEkc0sJpmqsX2EJB1ghTQOL1InY2MzyjPveHCiHqZZBfZt7NZ264/dcEotUlYQ8ZBK3O7pIoefY/f94wXfyUhZci585L0KODcDp8EaE7Ktqd1B0CjgiRR2c5JUn+ANHP5WT0zNeKhHWTP2JRFwsRFXTzW883GrE5uqnjeIJMynHv2b6fL/0T+dGbb2lv47/IxahGFHlNhieRjq2gyrvpSGDXgqMxZ4MfEnCnDrcRUmPjgKy6JXTjxbngKiBNcFHbCko9YW29y3deuZvFXVZ4zz01faRpHAT5KtZODsFK0zdoUpgLct1ZQdXNhdYoGWXh28xp8v9DgkSEM+eI4JL3oE+PKTfa6ir9BcJuNOrgnO1RttpQyYTNPZg3O23eQpBu3lp7STN5wXMn1IlHt+wJf5toLxA5Vlw2m1k0NsqyAKN3gk2T6Y7isHhuUvF9ggscwm6hHl52XHNI2d2Anfo3i2llceO0l381HUcuiBAV6rgfeLCQ6tgXzWIhchEzluybZ1yAspF9+4fUwo9qInJuv/UbAeHirlEfoAeCl+SoeLsP1HMQBQhNb2Gwdx5ZDl4IzVPJQCLBwa/ujHEHYe1LX9D0sn8tJGuPxuxQXlMgWHrbgUX0vlyoI=
notifications:
  slack:
    rooms:
    - secure: M+BuAf4koc3dYSvLyx0SO1E1A8A0gB55Gxby9IbS1oYvW9NhKS+si3Hoe6DW3m13fwkmSZK2P8J1ZEPUPFPQO8zdC63nXjROtJQSqeAv5b0Upu7xLxTeGB8K4Jq/n0sCGbtwhVMFZ0dufBCzNrAx1sh4N4fHgz5dYkk+SP/3MzJbbQsImKkDF9Hhc8zT+P8boDmyGHvoELcHS5EiWUZ20rsNiKPFkatrK+kc0OE9aB4wPpszHxK6XW0TVjrU0Lt0qrupzGNPQJETJT9jaXwKPsz9S6BPgcUF5HgvktnknygeiLZe+U9CLvmf9Pr2BlcZu7vmF+i+qMaOxn041hAkC/Wbih1UYFC/JvVfuM63MxFzTjmTbSKaXdD1D4T0ow2DQmegypbOS+UgsYJaCpV6gVHpr6OL+qP9xUvq9eTUXhJoExjYhGL+1YQnihi26UMgukflXvdPHzsEz2S2RFKiK76I42pehoq8YNUAabIei2ToT4BqsJV7lK81uF60o5EG6p2dpYQBiSOjp35XB35FAz4Xm1QoHgSMlk5IGfq/K+kHt6V0+Cil/Fz/vXk6RvohUmpI0JXCi5L4UoWZeKDIB3O3YEm68JTfL6RzMBBNCggkJNMD0gu+cp4upanridEVjYvHAagcOjgCovkdxDMBkwqTgj8tP99aVyi7hbEaqOI=
    on_success: always
    on_failure: always
before_script:
- echo "${DOCKER_HUB_PASSWORD}" | docker login --username sm4o --password-stdin
script:
- docker build --target test --tag todo.app:test .
- docker run --env-file .env.test todo.app:test tests
- docker run -e SECRET_KEY -e DATABASE_NAME -e DB_CONNECTION todo.app:test tests_e2e
install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- terraform init
before_deploy:
- docker build --target production --tag sm4o/todo.app:latest --tag sm4o/todo.app:$TRAVIS_COMMIT .
- docker push sm4o/todo.app --all-tags
- terraform apply -var 'prefix=test' -var "GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET" -var "SECRET_KEY=$SECRET_KEY" -auto-approve
deploy:
  provider: script
  script: bash ./scripts/webhook.sh
  skip_cleanup: true
  on:
    branch: master 
