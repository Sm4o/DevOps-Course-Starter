services:
- docker
env:
  matrix:
  - COMPOSE_VERSION=3.9
  global:
  - DATABASE_NAME=todo_app_db
  - APP_NAME=todo-app-corndel
  - secure: S4xtHUvLkLZCR+JmPUarsa2R+DfEI6xKdNr/YQ4mdjA+vdbJibl2N3QsCFmh6iEyKiRxILLUOQN6OAn3zP9wOk0OAr5HlRX2ell4MgGMcn3NjqPBLaYR6Z4GfTX0XOj3O7yjrmlifeDTm/kZxoRNAOfb5ttRomPYMTHHuBXM2tMMzsdSNcrFWs4aPALmfSsvDHOA7N7R8xLXLJZz4PEY/3Tzdvq22ZJvdCWhIJrjgcbPbZuSfsXiL82ocwpu/Gz0TABUC0Hsh/DtqCt8jMJbuHVqcEOjstxpM7N58a7CaCFVcA3ZsOOe+2K7i23kC+6RHyY7haIwh+xcyWnDLMlC8T2zNnlKwzedFz/CSVzngn1URp+t+08bT4RVBBgBdCcnka0TemHeJkgCACCgaGEDlorPEoAoU+ddJS5+spapeW2OisYovUUFv6btYwbP+z+tHp2gaLJbdn4qE70MODpfl5/aHmWaCk7MYG30Bq8PhB65BqW2kN7kuLRz3rUQf3AhTBmVF/DjtlXATeiWEe9ZiYwKVua/Vk9QxVRkt3MW4Rjq4OIJbz5UGGxNZylcCAYBhdv1Cd2J8wDRjvGL7zZoLKhdhExKCFgsQuu4e2f8eJMbflmDnYfckGKZqFPiIxUkMPYzQ+bP1Y5UFi+kc5asuzRXzeqejXmsxGNCM9EFH/I=
  - secure: Q1Ynbx0f5biAomX2OrgZ3cicDGnOPLZ66Z3dGmtDb7+YGy7Y6/q2JJQlAQanNS/+jSB0pHoB7Yk/9/00hXStCFV9Oi4tCUgFmkgKu7IU8cJs8g77v3SOqQpMFKIlN7I7Mv1hd3AnCBKZ2bRd9bwC+8EanUcT9ulN7gz/5TWMBqFvBS8pKeXaws9SDBg/VVys+qxvnhOaoaT7xmhSMAhTJrv39oznbDL+0tAUfN5JGoyUbvGl+0SUAD5jGGCnZuPTlOl497/mJAGBflEQSWXEQAeFnCdfgQeTiO40o/kA7L4Vo+ertP+jhzjjNKLSdKRNfyoWzl8DoM7HqpEQcPK+O+w6eMk5oMLWTIa2B3xc87uNZtJg/Ub10N2eq/AG4qv89wj6ApaWXG3WmbAUohmpwhfL/ekJ4f8cM2vuWMSxxZVW+6vixObK2dv3vzQOZbO/BCO4n2QmRdCvyg/eQQoE+ACJTqHczhVW1T2le/MoZfT1RT3SuxTtAwS9jWvql7Cf0iphmWrUuuKzaUBBG5D0Q998umg8Vj8mqfmUGnwwDO0V0Usadj2qJsJleQO/atoRsOZbhxTIPgXLpNz2yWiGxst81nxboMSaHgVrX7VeraA/RXtbLJU18ALFbZptK/ars4UM8x2xWuRtHYUa41hpa6F1iqVA6FCjNXaw4jVe3QM=
  - secure: jpowSVCTVhJGHliDJM7zpyNuxOVL0T3w/thMX4MZ4Xw3lMIn22nDvSIRVBK2sVrjH6UePkA84k7uGL+rbzn9S/6hJvbAb2BuuWi2m2cHA4fwxe8nzCHIz3nhWqM10KRemB2maRCBNJvFDz8NxYWhXjiz/Q++/B1p2zrkTbBFLs9ue+Nphq5n3szLCJLGw23jnwaiwq9hP382tc1FX8/5cecbOehpCYJLMTmN7XwdDBCkqwGiUYcs3ZvHXn3bOPoX+9ynDBHcrNYyYgnJdZkGrzPWbpBTR//PLYpB47ZRbXCfLTcxYuKLsSHWCSR6T0uco69JymEqMkAUVE9+jEzSc1g/u6GBLH77B7oonrOL69g1E4C27uXkPNE5+QM/a5mNKI2RM5/Ok7LcHm0SVdgqzehcLRYBr6rMtN86IYrvD85+m72Au2cPrQ/+5q2DlpQXs/AOkn032oHcgTl9YRQnVzdwcPficKZNHnlQpMyeOXg9gQjOzw/ijh6XqjxFnohpON2X1Xyib/9Cw2lsdYrEZqDnAEzu9bkazt3fuidrk66/sAsJ0gAhaQ765Al7HOIX8kbLsRhTaNREEnXfGwJMwTot3hCIhK64kPYleOTevYLMfmoEekkRWrpRzhhN/tTlNHXNhqqz3bqbM6UHVrWr9kojoHchrgg7aTQjp/cH/aY=
  - secure: qfyZGBMTFfjm6MEgFZ6D9m6V+/eqiy9LcwvxsP+qXcAJtxUzguW2552vrGVsSGzM4juUXUpL7GiuIBKU2vsFxoEJW6V5PQtAh4zMQESfGisjsJ190To0cPmh8EXhPmIRkGkHN4RSFfZNbBq/mRweeytZSGf09nBcKW+KZhpBDohR3QkqX0kZnfuOAHpHrtZlHRLABWR1xr1L7WWbykEQkbsp2bG2StsCzNKQjkhDL7fYLyyc6q2CTtCZjR7coDrQG89XjOr76USgufnOzZ5rLZIM4UDRYcX1+d/binDjauGmYJuVJ7435VJq3eHJ7A+2soqz52OF/JQYX5WAM/bs9KbMQw0ZVjffcC5SEzrgWA0Qsld0SA9H4LPDZgKJtASSWO52GZ9WDBSukvQjcUNIDXJ8ez+wGVr4C6vUbjOo14snOA4+MDQoZVkcaHLNkAeae8WBvrGNcS9sd8Ijxr8EtpwkOUdZ21DBbYY5knKWUpHy+79XWJheWYdw9Hu/xAQUGTsX+xzZfYlsJkbM0CUafdvuyHLgyubPk3BQh+bnZ0fZwn5wbjnLuG6d54v6tvSipdUbSToXGvl70aVliub61i3sK8XmfmtGvPj2bMzgRLUaTSit1CKaTpi0/YRR7DicHX0kT4fMTXx1mWKugymmQTiQfXgdYwkSxUdIWKJWnDQ=
notifications:
  slack:
    rooms:
    - secure: M+BuAf4koc3dYSvLyx0SO1E1A8A0gB55Gxby9IbS1oYvW9NhKS+si3Hoe6DW3m13fwkmSZK2P8J1ZEPUPFPQO8zdC63nXjROtJQSqeAv5b0Upu7xLxTeGB8K4Jq/n0sCGbtwhVMFZ0dufBCzNrAx1sh4N4fHgz5dYkk+SP/3MzJbbQsImKkDF9Hhc8zT+P8boDmyGHvoELcHS5EiWUZ20rsNiKPFkatrK+kc0OE9aB4wPpszHxK6XW0TVjrU0Lt0qrupzGNPQJETJT9jaXwKPsz9S6BPgcUF5HgvktnknygeiLZe+U9CLvmf9Pr2BlcZu7vmF+i+qMaOxn041hAkC/Wbih1UYFC/JvVfuM63MxFzTjmTbSKaXdD1D4T0ow2DQmegypbOS+UgsYJaCpV6gVHpr6OL+qP9xUvq9eTUXhJoExjYhGL+1YQnihi26UMgukflXvdPHzsEz2S2RFKiK76I42pehoq8YNUAabIei2ToT4BqsJV7lK81uF60o5EG6p2dpYQBiSOjp35XB35FAz4Xm1QoHgSMlk5IGfq/K+kHt6V0+Cil/Fz/vXk6RvohUmpI0JXCi5L4UoWZeKDIB3O3YEm68JTfL6RzMBBNCggkJNMD0gu+cp4upanridEVjYvHAagcOjgCovkdxDMBkwqTgj8tP99aVyi7hbEaqOI=
    on_success: always
    on_failure: always
before_script:
- echo "${DOCKER_HUB_PASSWORD}" | docker login --username sm4o --password-stdin
- echo "${HEROKU_API_KEY}" | docker login --username _ --password-stdin registry.heroku.com
script:
- docker build --target test --tag todo.app:test .
- docker run --env-file .env.test todo.app:test tests
- docker run -e SECRET_KEY -e DATABASE_NAME -e DB_CONNECTION todo.app:test tests_e2e
- "./scripts/run_build.sh"
deploy:
  provider: script
  script: bash ./scripts/deploy_heroku.sh
  on:
    branch: master
