services:
- docker
env:
  matrix:
  - COMPOSE_VERSION=3.9
  global:
  - DATABASE_NAME=todo_app_db
  - APP_NAME=todo-app-corndel
  - secure: bV9Z8x54taCWM9PtoIPSHXYduPPmkb0Wl2s7QqhTZdLYgQd2KB0/225Ho4nLfC1QqMCnEL0HeKfHPkfUSiPD9L3TDOUJWnqL+LyXqGPfYuLS1mvE8tyF0ste+MNRRc/2KiKOKcZ8fKqpdtLLogfPP5uE3+Ox92GpUaNYlSJdHwQEZrv5/tBy7AhYGS7kj6poIEKqTgcHXo5t0h5EUTdRnflYoUw2SPJOnov1cuz9Nm//8XLS5GD+YWB2IvH5bgHJi3C9s+LARIQ3IVJ0Nbm/tnDKznY0U5jSr4vizHcOYP7Im51XaR/MxriMcX3fFYpSS6sEqLCOx1S2Hz0OEUFUP5NcZ+8edThf7EL4ZZa9iHuFwGI2LmxbNnYsNmnASWsFJ/7qperw6y07+X9Tw2stlYyeevOMlN27jckZM2HMUYWua7ORddwgZjN+LcxpPYIrtOI2RSfub1+e907dCNRZbmaQY1E1I1QjquANR4qnJyLxIrKmu3XtsArpE98WhYnSJrOsWzSgXQJgoesfQW2sQNlajDEg44D7mgxV/no9LSzqa1C/5JuAzYvXLmxnaWr4YxHB8+KXuR1S2lCRFRuitT3Le16lubYxN7uPicn2cgitkAyJyqFKgVF+JJxYboGXTCXhyheEgR22KMEzknUa0KYkby79r2fDbY+86kTz75Y=
notifications:
  slack:
    rooms:
    - secure: M+BuAf4koc3dYSvLyx0SO1E1A8A0gB55Gxby9IbS1oYvW9NhKS+si3Hoe6DW3m13fwkmSZK2P8J1ZEPUPFPQO8zdC63nXjROtJQSqeAv5b0Upu7xLxTeGB8K4Jq/n0sCGbtwhVMFZ0dufBCzNrAx1sh4N4fHgz5dYkk+SP/3MzJbbQsImKkDF9Hhc8zT+P8boDmyGHvoELcHS5EiWUZ20rsNiKPFkatrK+kc0OE9aB4wPpszHxK6XW0TVjrU0Lt0qrupzGNPQJETJT9jaXwKPsz9S6BPgcUF5HgvktnknygeiLZe+U9CLvmf9Pr2BlcZu7vmF+i+qMaOxn041hAkC/Wbih1UYFC/JvVfuM63MxFzTjmTbSKaXdD1D4T0ow2DQmegypbOS+UgsYJaCpV6gVHpr6OL+qP9xUvq9eTUXhJoExjYhGL+1YQnihi26UMgukflXvdPHzsEz2S2RFKiK76I42pehoq8YNUAabIei2ToT4BqsJV7lK81uF60o5EG6p2dpYQBiSOjp35XB35FAz4Xm1QoHgSMlk5IGfq/K+kHt6V0+Cil/Fz/vXk6RvohUmpI0JXCi5L4UoWZeKDIB3O3YEm68JTfL6RzMBBNCggkJNMD0gu+cp4upanridEVjYvHAagcOjgCovkdxDMBkwqTgj8tP99aVyi7hbEaqOI=
    on_success: always
    on_failure: always
before_script:
- echo "${DOCKER_HUB_PASSWORD}" | docker login --username sm4o --password-stdin
- echo "${HEROKU_API_KEY}" | docker login --username _ --password-stdin registry.heroku.com
script:
- docker build --target test --tag todo.app:test .
# - docker run --env-file .env.test todo.app:test tests
- docker run --env DATABASE_NAME --env DB_CONNECTION --env SECRET_KEY todo.app:test tests_e2e
- "./scripts/run_build.sh"
deploy:
  provider: script
  script: bash ./scripts/deploy_heroku.sh
  on:
    branch: master
