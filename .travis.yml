services:
- docker
env:
  matrix:
  - COMPOSE_VERSION=3.9
  global:
  - DATABASE_NAME=todo_app_db
  - APP_NAME=todo-app-corndel
  - secure: DeQorP4H490J1+zWWrClH8YvS9HDsRK/qGXAl0jn4RfLl2cMGpbmzNY+NjMZEFdHNjihkRqqfJdVSazxfJ7cqhSY68sxocKD4QG9uWkld9TdNHAiURJ+gNa/4HLwU2O9TD1l+wYbt1x2kQFdI8B+WHGacVyI1Zkn1cGsAmfIsbWjLhv42qw6HySNzl2O+nx2vv9sJxbU07k932Rlmu+RxgLdBkrZ+E877GRawOvOQPlCk1imZcG8l6iM5LlbwAHrq9gmZTHH4gZVgM9UjYwCJvjHdUJM0tRlR1iHWEls1DkHGy+wY5CMlelWqrXXpR/X1f8XyTxx9aJHXAlCEFIJlSZoZ8wipnLK1K6ko/61y1c4xNLfl8t+01QIjYu7k1cwfiv7P4U+IObIG9G6maXPTjy/C99WuRnNCSL2pPzxrJRXQMJhamSnNqIW/inQoFmwxbENixFqnXWpZyQBxuOJn1yJdrkVoM+9yttPyM4dmDUAglI84/J/0/eKenomGyLc8vlddL463U8TCOSnETU8wutzm6jiK8YyofW3inmurw1jlsS/yNJOpxySNRGy0G5own0wRHb/5eKKxBo8M0CA0wckVCqknrxboyPLqB2S+9DaInssb7p1Kue7/VuFWVrN4tpOvIxdyMefBelmTLcHLTceP/8iiLGqNBBNKrP/bGE=
  - secure: wfrhPVQBFiZHuW4z2TWRXsMcLPD0HqTdCcoAEvQAXtoPKYl7HaJNAAjUyCgsc33fhurXDEVP1jHGH8/tcrsI7ZPunlMiUZ+/N4YroqOQJWFu948avbsqhuQctfRwwGVxyZBYnPeZ70cLjmfmkns94dg4J1v0dj+e1APeZbC568SB/Ly8MG/nmUOSfypacQ1grab7Qoy/DSXfM+8rjVwhmsOgm6iXwfomcRYzV6/6rNAIrWw9FkqQvasntUEc0m5Dg4ADZgWzQd4V0MOBxCupXTV75Ajkf/mVDEQbQAC4r7wA5pneY9oMYHo5/Ppy9mccGBmDTz0U/E8rLY9IFIKJd8Zd7zF1ryuDcYNlGLneQqa2uYdn6M/i5MVVXe4SvlUaBaheMJlBpQSgHzHr7B79myBpyrnQvm2YOJZBDOO+vYpJ/hU6LtkzdLcSl086cF3/hpWddw9+HsXLnWZ/tit3dbYBC835pC+soU70us0N/sciQXT3J3TPbbyCxFkWjrKdsEAdKWop+n34Z0wuBTkipU5gOS/j1x68/bqER4aUwTCzEhTcamMImtEt4xiek2EuPmHKykUAQsYeoa+O6oHESjlwNY6DPiIbLs0PnuWYjl6+I/+VG33aWeztDdbOBAGwdYRWrL2h0eGOxhSH3Bc4dK+GN67B482zJqoQhn+3SNk=
  - secure: zehoK9QIkIR8qVNE6qbnjbc/S20TtrAfHBiY3w5FSYQlFW8G2FObdJQaf49plDNqalO775zUKKbGe/L3akjS3NoYATIMvOaazLlQAzOooPrgj5eK5PNm28eyyNeNFyTycIHHiduz4uHTLcRsYe7IAQ2fCpvkzcbrSUVBqfyEjSMxg9MD8f7cdwCPuaX2A/rsTY7j8XRwMWqYEYtnCXwbcbv6klRv2EkjZPicvjs8HMHhh7Tnull8zWuwzdEQpcaRDjyl7Dm+sJlwRfzndD4e7MWGLB7u0EdQLoKT2t5SIUH6uFl8XWj5bPuVil9jF25bdgjrAat7gh/6bRJRioqx9XaUoGZwNQmS7Ke50bOJR28iaishylD2PjPDELUVuJ2C8gBcxhnJMeCuQvVX9uzSqYDp6SLvYS4BMVSh4Ny9c6u8gKEegx0GIgXPg1SUjQF0GR4BZH5tRop/A0FQnJhyzZ06fO/N4oF6OzYOQ+oowvQEgiMah8TQxfLKLCxsNHSy8gE5sAQ6Tf/JZO/JhkwRSRLv+BGmLstEqkolVM7N3T0loQlKmaf2IzKIUEulWAWJMroSBrk6JZxNXCG0NPkRagHKSvA2DdBSGrD0V9luocjISurBJ6mk6s4Q/dq8RqAgyzwHt9lEeKEBRmelmpZToau/dc7+MddkqGODdEL7p5U=
  - secure: RSdGge+QVDB5UvJHBKAJPnUwePmoYHXh1V07DBUK+r70GF2ShtJtvKHP+h7R4fRBKpoOwrCc4nPhMgTQUqXJ0l/77pZjLdNtyWgYCqx+evV2Gh4TKA27PfHEXdozpwnvSlwlXl5/VqYWvMtzQfeW3uzux4jbOQyaF8+LUedmK8p/41n3qRBzqzryNOsDaDnAQrSJU2zeKzRABo8OEdhyDl1AXp7kkn9pJY18TXGsL3TudVtOk2OgHX/YGfDmKt2NHeUWoK0dR+khta3LWX3N7O/5uA4v5EjZDjajoD1GOUu5/GSyHBeLNkpGjbz+DqHa7oxFjV2PTjbhQLtNBNvae3QStmN+JnXIrTMzp96N8gHfr7znMHgIq/FhXD+EoParX/ISlEPwre3vNKiieML/dtInrY46CQ6bDEMZ/05KHFHFTW+8hT0NL+JsAqX/LYv63x9sFkxrGdSuqOZ+IYy/iE/10O54wiGzcP38gM6e8d/wW+JXzJF6Tc/xnTjDPRpw8KIs0BOfWiYQjXuYwoaVgYaYBhaRaDNf7WOHotuL55G6Mh3F0Ulvn9oP4YAxCMexr8XcpnDqrTwHZJamiXWjwv6MKswzIbE9IRF9fuUA0SHVhklQqI3Y67qLscw/rehf3uNHvg47nyqw4nRu02qACRChx0nJHcXkNwAflSbIH3s=
notifications:
  slack:
    rooms:
    - secure: M+BuAf4koc3dYSvLyx0SO1E1A8A0gB55Gxby9IbS1oYvW9NhKS+si3Hoe6DW3m13fwkmSZK2P8J1ZEPUPFPQO8zdC63nXjROtJQSqeAv5b0Upu7xLxTeGB8K4Jq/n0sCGbtwhVMFZ0dufBCzNrAx1sh4N4fHgz5dYkk+SP/3MzJbbQsImKkDF9Hhc8zT+P8boDmyGHvoELcHS5EiWUZ20rsNiKPFkatrK+kc0OE9aB4wPpszHxK6XW0TVjrU0Lt0qrupzGNPQJETJT9jaXwKPsz9S6BPgcUF5HgvktnknygeiLZe+U9CLvmf9Pr2BlcZu7vmF+i+qMaOxn041hAkC/Wbih1UYFC/JvVfuM63MxFzTjmTbSKaXdD1D4T0ow2DQmegypbOS+UgsYJaCpV6gVHpr6OL+qP9xUvq9eTUXhJoExjYhGL+1YQnihi26UMgukflXvdPHzsEz2S2RFKiK76I42pehoq8YNUAabIei2ToT4BqsJV7lK81uF60o5EG6p2dpYQBiSOjp35XB35FAz4Xm1QoHgSMlk5IGfq/K+kHt6V0+Cil/Fz/vXk6RvohUmpI0JXCi5L4UoWZeKDIB3O3YEm68JTfL6RzMBBNCggkJNMD0gu+cp4upanridEVjYvHAagcOjgCovkdxDMBkwqTgj8tP99aVyi7hbEaqOI=
    on_success: always
    on_failure: always
before_script:
- echo "${DOCKER_HUB_PASSWORD}" | docker login --username sm4o --password-stdin
- echo "${HEROKU_API_KEY}" | docker login --username _ --password-stdin registry.heroku.com
script:
- docker build --target test --tag todo.app:test .
- docker run -e DATABASE_NAME -e DB_CONNECTION -e SECRET_KEY todo.app:test tests_e2e
- "./scripts/run_build.sh"
deploy:
  provider: script
  script: bash ./scripts/deploy_heroku.sh
  on:
    branch: master
